<!DOCTYPE html>
<html>
<head>
    <title>Security Report</title>
    <meta charset="utf-8">
    <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <style>
        body { 
            font-family: 'Prompt', sans-serif; 
            margin: 0; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container { 
            max-width: 400px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .report-btn { 
            width: 100%; 
            padding: 15px; 
            margin: 20px 0; 
            background: #06c755; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            font-size: 18px; 
            cursor: pointer;
        }
        .report-btn:disabled { 
            background: #cccccc; 
            cursor: not-allowed; 
        }
        .report-btn:hover:not(:disabled) { background: #05a944; }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px; 
            text-align: left;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .loading { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .debug-info { 
            background: #f8f9fa; 
            color: #495057; 
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .toggle-debug {
            background: none;
            border: none;
            color: #0066cc;
            text-decoration: underline;
            cursor: pointer;
            font-size: 12px;
            margin: 5px 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h1>
        
        <div id="pointInfo" class="status info">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
        <div id="userInfo" class="status info">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...</div>
        
        <button class="report-btn" id="reportBtn" onclick="submitReport()" disabled>
            ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
        </button>
        
        <div id="status"></div>
        
        <button class="toggle-debug" onclick="toggleDebug()">
            üêû ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Debug
        </button>
        
        <div id="debugInfo" class="debug-info hidden"></div>
    </div>

    <script>
        let userId = '';
        let displayName = '';
        let pointId = '';
        let isAppReady = false;
        let debugData = [];

        // Add debug log
        function addDebugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                data: data
            };
            debugData.push(logEntry);
            updateDebugDisplay();
            console.log(`[${timestamp}] ${message}`, data);
        }

        // Update debug display
        function updateDebugDisplay() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = debugData.map(entry => 
                `<div><strong>[${entry.time}]</strong> ${entry.message}${
                    entry.data ? `<br>${JSON.stringify(entry.data, null, 2)}` : ''
                }</div>`
            ).join('<hr>');
        }

        // Toggle debug visibility
        function toggleDebug() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.classList.toggle('hidden');
        }

        // Initialize LIFF
        async function initializeLiff() {
            addDebugLog('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î LIFF');
            
            try {
                addDebugLog('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á initialize LIFF...');
                await liff.init({ liffId: '2008503069-jNvaAdbw' });
                addDebugLog('‚úÖ LIFF initialize ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                
                if (!liff.isLoggedIn()) {
                    addDebugLog('üîê ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login, ‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect...');
                    liff.login();
                    return;
                }
                
                addDebugLog('üë§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...');
                
                // ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á profile ‡∏Å‡πà‡∏≠‡∏ô
                try {
                    const profile = await liff.getProfile();
                    userId = profile.userId;
                    displayName = profile.displayName;
                    addDebugLog('‚úÖ ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å getProfile', { 
                        userId: userId, 
                        displayName: displayName 
                    });
                } catch (profileError) {
                    addDebugLog('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á Profile ‡πÑ‡∏î‡πâ, ‡πÉ‡∏ä‡πâ Context ‡πÅ‡∏ó‡∏ô', profileError);
                    
                    // ‡πÉ‡∏ä‡πâ context ‡πÅ‡∏ó‡∏ô
                    const context = await liff.getContext();
                    userId = context.userId;
                    displayName = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ LINE';
                    
                    addDebugLog('‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Context', { 
                        userId: userId, 
                        displayName: displayName 
                    });
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ userId
                if (!userId) {
                    addDebugLog('‚ùå ERROR: ‡πÑ‡∏°‡πà‡∏°‡∏µ User ID');
                    document.getElementById('status').innerHTML = 
                        `<div class="status error">
                            <strong>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</strong><br>
                            <em>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</em>
                        </div>`;
                    return;
                }
                
                // Get point ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                pointId = urlParams.get('point') || 'A1';
                addDebugLog('üìç ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Point ID ‡∏à‡∏≤‡∏Å URL', { pointId });
                
                // Display info
                document.getElementById('pointInfo').innerHTML = 
                    `<strong>üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö:</strong> ${pointId}`;
                document.getElementById('userInfo').innerHTML = 
                    `<strong>üë§ ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${displayName}`;
                
                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ
                isAppReady = true;
                document.getElementById('reportBtn').disabled = false;
                document.getElementById('reportBtn').textContent = 'üìã ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ';
                
                addDebugLog('üéâ LIFF App ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                
            } catch (error) {
                addDebugLog('‚ùå LIFF Error', error);
                document.getElementById('status').innerHTML = 
                    `<div class="status error">
                        <strong>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏õ</strong><br>
                        <strong>Error:</strong> ${error.message}<br>
                        <em>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</em>
                    </div>`;
            }
        }

        // Submit report
        async function submitReport() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            if (!isAppReady) {
                addDebugLog('‚ö†Ô∏è App ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°, ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
                document.getElementById('status').innerHTML = 
                    '<div class="status error">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>';
                return;
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö
            if (!userId || !displayName || !pointId) {
                addDebugLog('‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', { userId, displayName, pointId });
                document.getElementById('status').innerHTML = 
                    '<div class="status error">‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>';
                return;
            }

            const reportBtn = document.getElementById('reportBtn');
            reportBtn.disabled = true;
            reportBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            
            addDebugLog('üì§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...');
            
            try {
                document.getElementById('status').innerHTML = 
                    '<div class="status loading"><strong>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...</strong><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>';

                const requestData = {
                    userId: userId,
                    displayName: displayName,
                    pointId: pointId
                };

                addDebugLog('üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á', requestData);

                const startTime = Date.now();
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                const responseTime = Date.now() - startTime;

                addDebugLog(`‚è±Ô∏è ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö response ‡πÉ‡∏ô ${responseTime}ms`, {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });

                const result = await response.json();
                addDebugLog('üì® Response data', result);

                if (result.success) {
                    addDebugLog('‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', { reportId: result.reportId });
                    document.getElementById('status').innerHTML = 
                        `<div class="status success">
                            <strong>‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong><br>
                            <strong>‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</strong> #${result.reportId}<br>
                            <strong>‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${pointId}<br>
                            <strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${new Date().toLocaleTimeString('th-TH')}<br>
                            <em>‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</em>
                        </div>`;
                } else {
                    addDebugLog('‚ùå API returned error', result);
                    let errorHtml = `<div class="status error">
                        <strong>‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</strong><br>`;
                    
                    if (result.error) errorHtml += `<strong>Error:</strong> ${result.error}<br>`;
                    if (result.details) errorHtml += `<strong>Details:</strong> ${result.details}<br>`;
                    
                    errorHtml += `<em>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</em></div>`;
                    
                    document.getElementById('status').innerHTML = errorHtml;
                }
                
            } catch (error) {
                addDebugLog('üí• Fetch error', error);
                document.getElementById('status').innerHTML = 
                    `<div class="status error">
                        <strong>‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</strong><br>
                        <strong>Error:</strong> ${error.message}<br>
                        <em>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</em>
                    </div>`;
            } finally {
                reportBtn.disabled = false;
                reportBtn.textContent = 'üìã ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ';
            }
        }

        // Start the app when page loads
        addDebugLog('üìÑ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢, ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF...');
        initializeLiff();
    </script>
</body>
</html>